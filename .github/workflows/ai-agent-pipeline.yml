name: AI Agent Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze'
        required: true
        type: number
      agents:
        description: 'Agents to run (comma-separated: validator,remediator,guardian,verifier or "all")'
        required: false
        default: 'all'
        type: string

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  # Job 1: Collect target PRs
  collect-prs:
    name: Collect Target PRs
    runs-on: ubuntu-latest
    outputs:
      pr_numbers: ${{ steps.get-prs.outputs.pr_numbers }}
    steps:
      - name: Get PR numbers
        id: get-prs
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "pr_numbers=[\"${{ inputs.pr_number }}\"]" >> $GITHUB_OUTPUT
          else
            echo "pr_numbers=[\"${{ github.event.pull_request.number }}\"]" >> $GITHUB_OUTPUT
          fi
      
      - name: Show target PRs
        run: |
          echo "Target PRs: ${{ steps.get-prs.outputs.pr_numbers }}"

  # Job 2: Run agents in parallel using matrix strategy
  run-agents:
    name: ${{ matrix.agent }} (PR ${{ matrix.pr }})
    runs-on: ubuntu-latest
    environment: METASERVER  # Access environment secrets
    needs: collect-prs
    if: needs.collect-prs.outputs.pr_numbers != '[]'
    
    strategy:
      fail-fast: false
      matrix:
        pr: ${{ fromJson(needs.collect-prs.outputs.pr_numbers) }}
        agent:
          - validator
          - remediator
          - guardian
          - verifier
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml httpx
          # Install project dependencies if needed
          if [ -f pyproject.toml ]; then
            pip install -e .
          fi
      
      - name: Verify environment
        run: |
          echo "=== Python Version ==="
          python --version
          
          echo "=== Installed Packages ==="
          pip list | grep -E "(httpx|pyyaml)"
          
          echo "=== Import Test ==="
          python -c "import httpx; import yaml; print('‚úÖ Imports successful')"
          
          echo "=== Environment Variables Check ==="
          echo "GITHUB_TOKEN: ${GITHUB_TOKEN:+SET}"
          echo "AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:+SET}"
          echo "MODELS_API_TOKEN: ${MODELS_API_TOKEN:+SET}"
          echo "MOONSHOT_API_KEY: ${MOONSHOT_API_KEY:+SET}"
          echo "OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:+SET}"
      
      - name: Run ${{ matrix.agent }} agent
        id: run-agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Azure OpenAI (for validator)
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          # GitHub Models (for remediator)
          MODELS_API_TOKEN: ${{ secrets.MODELS_API_TOKEN }}
          # Moonshot (for guardian)
          MOONSHOT_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
          # OpenRouter (for verifier)
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          set +e  # Don't exit on error immediately
          mkdir -p results
          
          echo "=== Running ${{ matrix.agent }} agent on PR ${{ matrix.pr }} ==="
          
          python -m scripts.agents.run_agent \
            --pr ${{ matrix.pr }} \
            --agent ${{ matrix.agent }} \
            --output results/${{ matrix.agent }}_pr${{ matrix.pr }}.json 2>&1 | tee agent_error.log
          
          exit_code=$?
          
          if [ $exit_code -ne 0 ]; then
            echo "‚ùå Agent failed with exit code: $exit_code"
            echo "=== Error Log ==="
            cat agent_error.log
            
            # Create error result file using Python for proper JSON generation
            EXIT_CODE=$exit_code python << 'PYEOF'
          import json
          import sys
          import os
          
          # Read error log
          try:
              with open('agent_error.log', 'r') as f:
                  error_log = f.read()[:5000]  # Limit to first 5000 chars
          except Exception as e:
              error_log = f"Failed to read error log: {e}"
          
          # Get exit code from environment
          exit_code = os.environ.get('EXIT_CODE', 'unknown')
          
          # Create error result
          error_result = {
              "agent": "${{ matrix.agent }}",
              "pr": int("${{ matrix.pr }}"),
              "verdict": "ERROR",
              "summary": "Agent execution failed - see workflow logs for details",
              "error": f"Exit code: {exit_code}",
              "error_log": error_log,
              "findings": []
          }
          
          # Write to file
          with open('results/${{ matrix.agent }}_pr${{ matrix.pr }}.json', 'w') as f:
              json.dump(error_result, f, indent=2)
          
          print("‚úÖ Created error result file")
          PYEOF
          fi
        continue-on-error: true
      
      - name: Upload results
        uses: actions/upload-artifact@v4.4.3
        if: always()
        with:
          name: ${{ matrix.agent }}-pr${{ matrix.pr }}-results
          path: results/${{ matrix.agent }}_pr${{ matrix.pr }}.json
          retention-days: 30

  # Job 3: Generate summary report
  generate-summary:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [collect-prs, run-agents]
    if: always() && needs.collect-prs.outputs.pr_numbers != '[]'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Download all results
        uses: actions/download-artifact@v4.1.3
        with:
          path: results/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Generate summary
        run: |
          python << 'PYTHON_SCRIPT'
          import json
          import os
          from pathlib import Path
          
          # Find all result files
          results_dir = Path("results")
          all_results = {}
          
          # Handle case where results directory doesn't exist or is empty
          if not results_dir.exists():
              print("‚ö†Ô∏è No results directory found - all agents may have failed")
              summary = "# ü§ñ AI Agent Pipeline Results\n\n"
              summary += "‚ö†Ô∏è **Warning**: No results directory found. All agents may have failed to execute.\n"
              summary += "\nCheck individual job logs for details.\n"
              with open(os.environ["GITHUB_STEP_SUMMARY"], "w") as f:
                  f.write(summary)
              print(summary)
              exit(0)
          
          # Check if directory is empty
          if not any(results_dir.iterdir()):
              print("‚ö†Ô∏è Results directory is empty - no artifacts were uploaded")
              summary = "# ü§ñ AI Agent Pipeline Results\n\n"
              summary += "‚ö†Ô∏è **Warning**: No agent results were uploaded.\n"
              summary += "\nCheck individual job logs for details.\n"
              with open(os.environ["GITHUB_STEP_SUMMARY"], "w") as f:
                  f.write(summary)
              print(summary)
              exit(0)
          
          for artifact_dir in results_dir.iterdir():
              if artifact_dir.is_dir():
                  for result_file in artifact_dir.glob("*.json"):
                      try:
                          with open(result_file) as f:
                              data = json.load(f)
                              agent_name = result_file.stem.split("_")[0]
                              pr_num = result_file.stem.split("pr")[1].replace(".json", "")
                              
                              if pr_num not in all_results:
                                  all_results[pr_num] = {}
                              all_results[pr_num][agent_name] = data
                      except Exception as e:
                          print(f"‚ö†Ô∏è Failed to parse {result_file}: {e}")
          
          # Generate markdown summary
          summary = "# ü§ñ AI Agent Pipeline Results\n\n"
          
          if not all_results:
              summary += "‚ö†Ô∏è **Warning**: No valid results found.\n"
              summary += "\nCheck individual job logs for details.\n"
          
          for pr_num, agents in sorted(all_results.items()):
              summary += f"## PR #{pr_num}\n\n"
              summary += "| Agent | Verdict | Summary |\n"
              summary += "|-------|---------|----------|\n"
              
              for agent_name, result in sorted(agents.items()):
                  verdict = result.get("verdict", "UNKNOWN")
                  emoji = {"PASS": "‚úÖ", "WARN": "‚ö†Ô∏è", "FAIL": "‚ùå", "BLOCK": "üö´", "ERROR": "üí•"}.get(verdict, "‚ùì")
                  agent_display = agent_name.title()
                  summary_text = result.get("summary", "No summary")[:100]
                  
                  summary += f"| {emoji} {agent_display} | {verdict} | {summary_text} |\n"
              
              summary += "\n"
          
          # Write to GitHub Step Summary
          with open(os.environ["GITHUB_STEP_SUMMARY"], "w") as f:
              f.write(summary)
          
          print(summary)
          PYTHON_SCRIPT
      
      - name: Upload combined results
        uses: actions/upload-artifact@v4.4.3
        with:
          name: ai-agent-pipeline-results
          path: results/
          retention-days: 90

  # Job 4: Check overall status
  check-status:
    name: Check Overall Status
    runs-on: ubuntu-latest
    needs: [run-agents]
    if: always()
    
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4.1.3
        with:
          path: results/
      
      - name: Check for blocking issues
        run: |
          python << 'PYTHON_SCRIPT'
          import json
          import sys
          from pathlib import Path
          
          # Find all result files
          results_dir = Path("results")
          has_block = False
          has_fail = False
          has_error = False
          
          # Handle missing results directory
          if not results_dir.exists():
              print("‚ö†Ô∏è No results directory found - treating as error state")
              sys.exit(1)
          
          # Handle empty directory
          if not any(results_dir.iterdir()):
              print("‚ö†Ô∏è No results found - treating as error state")
              sys.exit(1)
          
          for artifact_dir in results_dir.iterdir():
              if artifact_dir.is_dir():
                  for result_file in artifact_dir.glob("*.json"):
                      try:
                          with open(result_file) as f:
                              data = json.load(f)
                              verdict = data.get("verdict", "")
                              
                              if verdict == "BLOCK":
                                  has_block = True
                                  print(f"üö´ BLOCK found in {result_file.name}")
                              elif verdict == "FAIL":
                                  has_fail = True
                                  print(f"‚ùå FAIL found in {result_file.name}")
                              elif verdict == "ERROR" or "error" in data:
                                  has_error = True
                                  print(f"‚ö†Ô∏è ERROR found in {result_file.name}")
                      except json.JSONDecodeError as e:
                          print(f"‚ö†Ô∏è Could not parse {result_file.name}: {e}")
                          has_error = True
                      except Exception as e:
                          print(f"‚ö†Ô∏è Error reading {result_file.name}: {e}")
                          has_error = True
          
          if has_block:
              print("\nüö´ BLOCKING ISSUES FOUND - PR should not be merged")
              sys.exit(2)
          elif has_fail or has_error:
              print("\n‚ùå FAILURES FOUND - Review required")
              sys.exit(1)
          else:
              print("\n‚úÖ All agents passed")
              sys.exit(0)
          PYTHON_SCRIPT
