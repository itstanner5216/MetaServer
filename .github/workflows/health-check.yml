name: ðŸ¥ Repository Health Check

on:
  schedule:
    - cron: '0 0 * * 1'  # Every Monday at midnight UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: read
  pull-requests: read

jobs:
  health-check:
    name: Weekly Repository Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6
      
      - name: ðŸ”§ Setup GitHub CLI
        run: |
          gh --version
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: ðŸ›¡ï¸ Check Branch Protection
        id: branch-protection
        run: |
          echo "ðŸ” Checking branch protection status..."
          
          # Verify branch protection is still active
          PROTECTION=$(gh api repos/${{ github.repository }}/branches/main/protection 2>/dev/null || echo "not-protected")
          
          if [ "$PROTECTION" = "not-protected" ]; then
            echo "âš ï¸ Branch protection is NOT active on main branch"
            echo "branch_protection=failed" >> $GITHUB_OUTPUT
          else
            # Check if we got valid JSON response (not the fallback string)
            if echo "$PROTECTION" | jq -e . >/dev/null 2>&1; then
              echo "âœ… Branch protection is active"
              echo "branch_protection=success" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Unable to verify branch protection status"
              echo "branch_protection=unknown" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
      
      - name: ðŸ”’ Check Security Features
        id: security
        run: |
          echo "ðŸ” Checking security features..."
          
          # Verify security features enabled
          SECURITY=$(gh api repos/${{ github.repository }} | jq '.security_and_analysis')
          
          echo "Security features status:"
          echo "$SECURITY" | jq '.'
          
          # Check for security features
          VULN_ALERTS=$(echo "$SECURITY" | jq -r '.vulnerability_alerts.status // "disabled"')
          SECRET_SCANNING=$(echo "$SECURITY" | jq -r '.secret_scanning.status // "disabled"')
          
          echo ""
          echo "Vulnerability Alerts: $VULN_ALERTS"
          echo "Secret Scanning: $SECRET_SCANNING"
          
          if [ "$VULN_ALERTS" = "enabled" ]; then
            echo "âœ… Vulnerability alerts enabled"
          else
            echo "âš ï¸ Vulnerability alerts disabled"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
      
      - name: ðŸ“¦ Check Dependabot Status
        id: dependabot
        run: |
          echo "ðŸ” Checking for pending Dependabot PRs..."
          
          # Check for pending Dependabot PRs
          DEPENDABOT_PRS=$(gh pr list --label dependencies --json number,title,createdAt --jq 'length')
          
          echo "Pending Dependabot PRs: $DEPENDABOT_PRS"
          
          if [ "$DEPENDABOT_PRS" -gt 0 ]; then
            echo "ðŸ“‹ Dependabot PRs found:"
            gh pr list --label dependencies --json number,title,createdAt
          else
            echo "âœ… No pending Dependabot PRs"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
      
      - name: ðŸ” Check Workflow Status
        id: workflows
        run: |
          echo "ðŸ” Checking recent workflow runs..."
          
          # Get recent workflow runs
          FAILED_RUNS=$(gh run list --limit 10 --json conclusion,name,startedAt | jq '[.[] | select(.conclusion == "failure")] | length')
          
          echo "Failed workflow runs (last 10): $FAILED_RUNS"
          
          if [ "$FAILED_RUNS" -gt 0 ]; then
            echo "âš ï¸ Recent workflow failures detected:"
            gh run list --limit 10 --json conclusion,name,startedAt,url | jq '.[] | select(.conclusion == "failure")'
          else
            echo "âœ… No recent workflow failures"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
      
      - name: ðŸ“Š Generate Health Report
        if: always()
        run: |
          echo "# ðŸ¥ Repository Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Health Check Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch Protection | ${{ steps.branch-protection.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Features | ${{ steps.security.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependabot Check | ${{ steps.dependabot.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Status | ${{ steps.workflows.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“ Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Review and merge pending Dependabot PRs" >> $GITHUB_STEP_SUMMARY
          echo "- Address any failed workflow runs" >> $GITHUB_STEP_SUMMARY
          echo "- Keep branch protection rules up to date" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor security alerts regularly" >> $GITHUB_STEP_SUMMARY
