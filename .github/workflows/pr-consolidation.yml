name: üîÑ PR Consolidation and Cleanup

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Operation mode'
        required: true
        type: choice
        options:
          - analyze_only
          - consolidate_prs
          - cleanup_comments
          - full_process
        default: 'analyze_only'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  consolidate:
    name: Consolidate Duplicate PRs
    runs-on: ubuntu-latest
    if: inputs.mode == 'consolidate_prs' || inputs.mode == 'full_process' || inputs.mode == 'analyze_only'
    outputs:
      summary: ${{ steps.consolidate.outputs.summary }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install httpx
      
      - name: Analyze PRs (dry run)
        if: inputs.mode == 'analyze_only'
        run: |
          python scripts/consolidate_prs.py \
            --repo ${{ github.repository }} \
            --token ${{ secrets.GITHUB_TOKEN }}
      
      - name: Consolidate PRs
        id: consolidate
        if: inputs.mode != 'analyze_only'
        run: |
          python scripts/consolidate_prs.py \
            --repo ${{ github.repository }} \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --execute
          
          echo "summary=$(cat pr_consolidation_summary.json)" >> $GITHUB_OUTPUT
      
      - name: Upload summary
        if: inputs.mode != 'analyze_only'
        uses: actions/upload-artifact@v4
        with:
          name: pr-consolidation-summary
          path: pr_consolidation_summary.json
          retention-days: 90
  
  cleanup-comments:
    name: Clean Up AI Comments
    runs-on: ubuntu-latest
    needs: consolidate
    if: |
      always() && 
      (inputs.mode == 'cleanup_comments' || inputs.mode == 'full_process')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install httpx
      
      - name: Clean up comments
        run: |
          python scripts/cleanup_ai_comments.py \
            --repo ${{ github.repository }} \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --execute
  
  re-run-review:
    name: Re-run AI Review Pipeline
    runs-on: ubuntu-latest
    needs: [consolidate, cleanup-comments]
    if: always() && inputs.mode == 'full_process'
    
    steps:
      - name: Trigger AI PR Review Pipeline
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ai-pr-review-pipeline.yml',
              ref: 'main',
              inputs: {
                pr_numbers: 'all',
                agent_mode: 'review_and_fix'
              }
            });
            
            core.info('‚úÖ AI PR Review Pipeline triggered for all remaining PRs');
  
  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [consolidate, cleanup-comments, re-run-review]
    if: always()
    
    steps:
      - name: Generate Summary
        uses: actions/github-script@v7
        with:
          script: |
            const mode = '${{ inputs.mode }}';
            
            let summary = '# üîÑ PR Consolidation Summary\n\n';
            summary += `**Mode:** ${mode}\n\n`;
            
            summary += '## Jobs Executed\n\n';
            summary += '| Job | Status |\n';
            summary += '|-----|--------|\n';
            summary += `| Consolidate PRs | ${{ needs.consolidate.result || 'skipped' }} |\n`;
            summary += `| Cleanup Comments | ${{ needs.cleanup-comments.result || 'skipped' }} |\n`;
            summary += `| Re-run Review | ${{ needs.re-run-review.result || 'skipped' }} |\n`;
            
            if (mode === 'full_process') {
              summary += '\n## Next Steps\n\n';
              summary += '1. ‚úÖ Duplicate PRs have been closed\n';
              summary += '2. ‚úÖ Old AI comments have been removed\n';
              summary += '3. ‚úÖ AI Review Pipeline has been triggered\n';
              summary += '4. ‚è≥ Wait for new AI reviews to appear on remaining PRs\n';
              summary += '5. üìã Review the remaining PRs and merge when ready\n';
            }
            
            core.summary.addRaw(summary);
            await core.summary.write();
